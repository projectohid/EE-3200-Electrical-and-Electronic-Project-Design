<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ECG Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Roboto, Arial;
        background: #f9f9fb;
        margin: 0;
      }
      header {
        background: #1a73e8;
        color: white;
        padding: 16px;
      }
      h1 {
        margin: 0;
        font-size: 1.5em;
      }
      #container {
        max-width: 1000px;
        margin: 24px auto;
        padding: 16px;
      }
      .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        padding: 16px;
        margin-bottom: 20px;
      }
      .row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }
      label {
        font-weight: bold;
      }
      input,
      button {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      button {
        background: #1a73e8;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background: #1558b0;
      }
      .metrics {
        display: flex;
        gap: 20px;
        font-size: 1.2em;
      }
      .metric span {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <header><h1>Wireless ECG Dashboard</h1></header>
    <div id="container">
      <div class="card">
        <div class="row">
          <label>Device ID:</label>
          <input id="deviceId" value="esp32-ecg-01" />
          <button id="connect">Connect</button>
        </div>
        <p id="status">Connecting…</p>
      </div>

      <div class="card">
        <h2>Live ECG</h2>
        <canvas id="ecg" height="100"></canvas>
      </div>

      <div class="card">
        <h2>Heart Rate</h2>
        <div class="metrics">
          <div class="metric">BPM: <span id="bpm">--</span></div>
          <div class="metric">Condition: <span id="cond">--</span></div>
        </div>
        <canvas id="hr" height="100"></canvas>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
      import {
        getDatabase,
        ref,
        query,
        limitToLast,
        onChildAdded,
        off,
      } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

      // ===== Firebase config (replace with your project values) =====
      const firebaseConfig = {
        apiKey: "AIzaSyBJkfaMqeF4VOD1RKiSaEQoSLjlRGT2UKs",
        authDomain: "ecg-monitor-ohid.firebaseapp.com",
        databaseURL:
          "https://ecg-monitor-ohid-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "ecg-monitor-ohid",
        storageBucket: "ecg-monitor-ohid.firebasestorage.app",
        messagingSenderId: "743049129470",
        appId: "1:743049129470:web:4d6230ea0c98d3500424af",
        measurementId: "G-X21ZR8T2QK",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ===== Charts =====
      const ECG_LEN = 10 * 250;
      const ecgData = Array(ECG_LEN).fill(0);
      const ecgChart = new Chart(document.getElementById("ecg"), {
        type: "line",
        data: {
          labels: Array(ECG_LEN).fill(""),
          datasets: [
            {
              data: ecgData,
              borderColor: "#1a73e8",
              borderWidth: 1,
              pointRadius: 0,
            },
          ],
        },
        options: {
          animation: false,
          scales: {
            x: { display: false },
            y: { title: { display: true, text: "ECG (counts)" } },
          },
        },
      });

      const hrData = [];
      const hrChart = new Chart(document.getElementById("hr"), {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              data: hrData,
              borderColor: "#e91e63",
              borderWidth: 2,
              pointRadius: 3,
            },
          ],
        },
        options: {
          animation: false,
          scales: { y: { title: { display: true, text: "BPM" } } },
        },
      });

      const bpmEl = document.getElementById("bpm");
      const condEl = document.getElementById("cond");
      const statusEl = document.getElementById("status");

      // ===== R-peak detection =====
      let lastPeakTime = null;
      function detectPeaks(samples, fs = 250) {
        const threshold = 600; // adjust if needed
        const refractory = 0.25 * fs; // 250 ms
        const peaks = [];
        for (let i = 1; i < samples.length - 1; i++) {
          if (
            samples[i] > threshold &&
            samples[i] > samples[i - 1] &&
            samples[i] > samples[i + 1]
          ) {
            if (!lastPeakTime || i - lastPeakTime > refractory) {
              peaks.push(i);
              lastPeakTime = i;
            }
          }
        }
        return peaks;
      }

      // ===== Connection logic =====
      const devInput = document.getElementById("deviceId");
      const btn = document.getElementById("connect");
      let unsub = null;

      function connect(deviceId) {
        if (unsub) {
          off(unsub);
          unsub = null;
        }
        statusEl.textContent = `Listening to ${deviceId}…`;

        const q = query(ref(db, `/ecg/${deviceId}`), limitToLast(20));
        unsub = onChildAdded(q, (snap) => {
          const v = snap.val();
          if (!v || !v.samples) return;
          for (const s of v.samples) {
            ecgData.push(s);
            if (ecgData.length > ECG_LEN) ecgData.shift();
          }
          ecgChart.update();

          // Process new chunk
          const peaks = detectPeaks(v.samples, v.sr || 250);
          if (peaks.length >= 2) {
            const rr = (peaks[peaks.length - 1] - peaks[0]) / (v.sr || 250); // seconds
            const bpm = 60 / rr;
            bpmEl.textContent = bpm.toFixed(0);
            hrData.push(bpm);
            hrChart.data.labels.push("");
            if (hrData.length > 30) {
              hrData.shift();
              hrChart.data.labels.shift();
            }
            hrChart.update();

            // Simple conditions
            let cond = "Normal";
            if (bpm < 50) cond = "Bradycardia";
            else if (bpm > 120) cond = "Tachycardia";
            condEl.textContent = cond;
          }
        });
      }
      btn.onclick = () => connect(devInput.value.trim());
      connect(devInput.value.trim());
    </script>
  </body>
</html>
