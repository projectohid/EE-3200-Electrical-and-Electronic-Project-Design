<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ECG Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Roboto, Arial;
        background: #f9f9fb;
        margin: 0;
      }
      header {
        background: #1a73e8;
        color: white;
        padding: 16px;
      }
      h1 {
        margin: 0;
        font-size: 1.5em;
      }
      #container {
        max-width: 1000px;
        margin: 24px auto;
        padding: 16px;
      }
      .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        padding: 16px;
        margin-bottom: 20px;
      }
      .row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }
      label {
        font-weight: bold;
      }
      input,
      button {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      button {
        background: #1a73e8;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background: #1558b0;
      }
      .metrics {
        display: flex;
        gap: 20px;
        font-size: 1.2em;
      }
      .metric span {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <header><h1>Wireless ECG Dashboard</h1></header>
    <div id="container">
      <div class="card">
        <div class="row">
          <label>Device ID:</label>
          <input id="deviceId" value="esp32-ecg-01" />
          <button id="connect">Connect</button>
        </div>
        <p id="status">Connecting…</p>
        <div class="row">
          <label
            ><input type="checkbox" id="showRaw" /> Show raw instead of
            filtered</label
          >
          <span style="margin-left: auto"
            >Signal (p-p, last 2s): <strong id="pp">--</strong></span
          >
        </div>
      </div>

      <div class="card">
        <h2>Live ECG</h2>
        <canvas id="ecg" height="100"></canvas>
      </div>

      <div class="card">
        <h2>Heart Rate</h2>
        <div class="metrics">
          <div class="metric">BPM: <span id="bpm">--</span></div>
          <div class="metric">Condition: <span id="cond">--</span></div>
        </div>
        <canvas id="hr" height="100"></canvas>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
      import {
        getDatabase,
        ref,
        query,
        limitToLast,
        onChildAdded,
        off,
      } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

      // ===== Firebase config =====
      const firebaseConfig = {
        apiKey: "AIzaSyBJkfaMqeF4VOD1RKiSaEQoSLjlRGT2UKs",
        authDomain: "ecg-monitor-ohid.firebaseapp.com",
        databaseURL:
          "https://ecg-monitor-ohid-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "ecg-monitor-ohid",
        storageBucket: "ecg-monitor-ohid.firebasestorage.app",
        messagingSenderId: "743049129470",
        appId: "1:743049129470:web:4d6230ea0c98d3500424af",
        measurementId: "G-X21ZR8T2QK",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ===== Charts =====
      const ECG_LEN = 10 * 250;
      const ecgData = Array(ECG_LEN).fill(0);
      const ecgChart = new Chart(document.getElementById("ecg"), {
        type: "line",
        data: {
          labels: Array(ECG_LEN).fill(""),
          datasets: [
            {
              data: ecgData,
              borderColor: "#1a73e8",
              borderWidth: 1,
              pointRadius: 0,
            },
          ],
        },
        options: {
          animation: false,
          scales: {
            x: { display: false },
            y: { title: { display: true, text: "ECG (counts)" } },
          },
        },
      });

      const hrData = [];
      const hrChart = new Chart(document.getElementById("hr"), {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              data: hrData,
              borderColor: "#e91e63",
              borderWidth: 2,
              pointRadius: 3,
            },
          ],
        },
        options: {
          animation: false,
          scales: { y: { title: { display: true, text: "BPM" } } },
        },
      });

      const bpmEl = document.getElementById("bpm");
      const condEl = document.getElementById("cond");
      const statusEl = document.getElementById("status");
      const showRawEl = document.getElementById("showRaw");
      const ppEl = document.getElementById("pp");

      // ===== R-peak detection =====
      let peakTimes = [];
      const fs = 250;
      const threshold = 600;
      const refractory = 0.25 * fs;

      let sampleCounter = 0;

      function processECGChunk(samples) {
        // compute p-p over last ~2s
        const seg = ecgData.slice(-fs * 2);
        ppEl.textContent = peakToPeak(seg);

        for (let i = 1; i < samples.length - 1; i++) {
          const s = samples[i];
          if (s > threshold && s > samples[i - 1] && s > samples[i + 1]) {
            if (
              peakTimes.length === 0 ||
              sampleCounter + i - peakTimes[peakTimes.length - 1] > refractory
            ) {
              peakTimes.push(sampleCounter + i);
              if (peakTimes.length > 10) peakTimes.shift();

              if (peakTimes.length >= 2) {
                const rrIntervals = [];
                for (let k = 1; k < peakTimes.length; k++) {
                  rrIntervals.push((peakTimes[k] - peakTimes[k - 1]) / fs);
                }
                const avgRR =
                  rrIntervals.reduce((a, b) => a + b, 0) / rrIntervals.length;
                const bpm = 60 / avgRR;

                bpmEl.textContent = bpm.toFixed(0);
                hrData.push(bpm);
                hrChart.data.labels.push("");
                if (hrData.length > 30) {
                  hrData.shift();
                  hrChart.data.labels.shift();
                }
                hrChart.update();

                let cond = "Normal";
                if (bpm < 50) cond = "Bradycardia";
                else if (bpm > 120) cond = "Tachycardia";
                condEl.textContent = cond;
              }
            }
          }
        }
        sampleCounter += samples.length;
      }

      // ===== Helper =====
      function peakToPeak(arr) {
        let min = Infinity,
          max = -Infinity;
        for (const x of arr) {
          if (x < min) min = x;
          if (x > max) max = x;
        }
        return (max - min).toFixed(0);
      }

      // ===== Connection logic =====
      const devInput = document.getElementById("deviceId");
      const btn = document.getElementById("connect");
      let unsub = null;

      function connect(deviceId) {
        if (unsub) {
          off(unsub);
          unsub = null;
        }
        statusEl.textContent = `Listening to ${deviceId}…`;

        const q = query(ref(db, `/ecg/${deviceId}`), limitToLast(20));
        unsub = onChildAdded(q, (snap) => {
          const v = snap.val();
          if (!v) return;

          // choose raw or filtered
          const samples = showRawEl.checked
            ? v.samples
            : v.filtered || v.samples;

          for (const s of samples) {
            ecgData.push(s);
            if (ecgData.length > ECG_LEN) ecgData.shift();
          }
          ecgChart.update();

          processECGChunk(samples);
        });
      }
      btn.onclick = () => connect(devInput.value.trim());
      connect(devInput.value.trim());
    </script>
  </body>
</html>
